<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Aus Stage</title>
        <style type="text/css" media="screen">@import "assets/jqtouch/jqtouch.min.css";</style>
        <style type="text/css" media="screen">@import "assets/jqtouch/themes/ausstage/theme.css";</style>
        <script src="assets/jqtouch/jquery.1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="assets/jqtouch/jqtouch.min.js" type="application/x-javascript" charset="utf-8"></script>
          <script src="assets/jqtouch/extensions/jqt.location.js" type="application/x-javascript" charset="utf-8"></script>


        <script type="text/javascript" src="assets/javascript/chain-0.2.js" type="application/x-javascript" charset="utf-8"></script>


        <script type="text/javascript" charset="utf-8">
            var jQT = new $.jQTouch({
                icon: 'jqtouch.png',
                addGlossToIcon: false,
                startupScreen: 'jqt_startup.png',
                statusBar: 'black',
                preloadImages: [
                    'assets/jqtouch/themes/jqt/img/back_button.png',
                    'assets/jqtouch/themes/jqt/img/back_button_clicked.png',
                    'assets/jqtouch/themes/jqt/img/button_clicked.png',
                    'assets/jqtouch/themes/jqt/img/grayButton.png',
                    'assets/jqtouch/themes/jqt/img/whiteButton.png',
                    'assets/jqtouch//themes/jqt/img/loading.gif'
                    ]
            });
			
        	//Glabals
			var gCurrentPerformance = 0;
		
		  var _gaq = _gaq || [];
		   _gaq.push(['_setAccount', 'UA-3158456-14']);
		
		
		
		  (function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
		  
  
  		//Our main document load 
		$(document).ready(function() {			
			
		
			  			
			//Do have any URL variables - if so load those and then display the current performance form.    
			if(window.location.href.indexOf('?') != -1) {
				
				var performanceVariables = ['p','performance'];
				
				for (var i = 0; i < performanceVariables.length; i++) {
					if (getUrlVars()[ performanceVariables[i]]) {
						gCurrentPerformance = getUrlVars()[ performanceVariables[i]];
					    _gaq.push(['_trackPageview', 'DirectLinkToForm/?performance=' + gCurrentPerformance ]);

						getPerformanceData();	
						jQT.goTo('#FeedbackDisplayWithForm');
					}
				
			}
			}
			
		});
		
		// function to get parameters from url
			function getUrlVars()
				{
					var pairs;
					var pairs = window.location.href.slice(window.location.href.indexOf('?') + 1);

					//the url might be ?p=4#Home so we make sure we just dealing bit before the #
					if (pairs.indexOf("#") != -1) {
						var firstArray = pairs.split('#'); //make that into array rid of it.
						var UrlVars = firstArray[0];    
					} else {
						var UrlVars = pairs[0];
					
						//just return the first param 
					}
					
					window.console.log("url variables = " + UrlVars);					
						
					 var vars = [], hash;
					 var hashes = UrlVars.split('&');
					 
					 for(var i = 0; i < hashes.length; i++)
						{
							hash = hashes[i].split('=');
							vars.push(hash[0]);
							vars[hash[0]] = hash[1];
					}
					
					return vars;
					
			
			
		}
		

		function submitForm(){
			
		//	alert("submitting the form"); 
			  window.console.log("about to submit the form");
			   
			   _gaq.push(['_trackPageview', 'FormSubmitted/?performance=' + gCurrentPerformance ]);
			   
				//figure out which server we one 
				host = buildHost();
				
				//now do the stuff to make the host names work 
				  if (host != 'http://beta.ausstage.edu.au')  { 
					  host = 'http://beta.ausstage.edu.au';
					  mydataType =  'jsonp';
				  } else {
					   mydataType =  'json';
				  }
				  				  
				//window.console.log(source)	;
	
				//Get the date and time; 
				var CurrentDate = new Date(); 
				var currentTime =  CurrentDate.toTimeString();
				//Change the format of the date so that works with API
				currentTime =  currentTime.replace(" (EST)", "", "gi");  
				currentTime =  currentTime.replace("GMT", "", "gi");  
								
				//bulld the  
				
				// get the message form the form
				
				var message =  $('[name=message]').val();
				
				 var params = {
					 
					 type:'mobile-web',
					 time:currentTime,
				 	 date:CurrentDate.toDateString(),
					 performance:gCurrentPerformance,
					 message:message	 
				 
				 };
				 var values = jQuery.param(params);//encode thos
				
				var source =  host + '/mobile/gatherer?' +  values;

				window.console.log(values);
				
				$.ajax({
						type:   'GET',
						url: source, 
						dataType: mydataType,
						success: function (data) {
							
								getPerformanceData();	
								jQT.goTo('#FeedbackDisplay');

						},
						error:function (xhr, ajaxOptions, thrownError){
                    	alert(xhr.status);
                    	alert(thrownError);
						jQT.goTo('#Error');

                	},
					
						async: true 
					});	
		}
		
		
		 function setLocDisplay(text) {
					$('.LocInfo').empty().append(text);
					
                }
				
				
		function findLocation(){
		        
				 _gaq.push(['_trackPageview', 'PerformancesNearBy']);
        

                // We pass "updateLocation" a callback function,
                // to run once we have the coordinates.
                // We also set it to a variable, so we can know
                // right away if it's working or not
                var lookup = jQT.updateLocation(function(coords){
                    if (coords) {
                        setLocDisplay('Latitude: ' + coords.latitude + '<br />Longitude: ' + coords.longitude);
                    } else {
                       setLocDisplay('Device not capable of geo-location.');
                    }
                });

                if (lookup) {
                    setLocDisplay('Looking up location&hellip;');
                }		
					
		}
		
		function buildHost() {
			
			 var host = $(location).attr('host');
			 return host;
				  
			
		}
		function getPerformanceData() {
				
				_gaq.push(['_trackPageview', 'LoadingPerformanceData/?performance=' + gCurrentPerformance]);


				host = buildHost();
				
				//now do the stuff to make the host names work 
				  if (host != 'http://beta.ausstage.edu.au')  { 
					  host = 'http://beta.ausstage.edu.au';
					  mydataType =  'jsonp';
				  } else {
					   mydataType =  'json';
				  }
				  
				  
				 
				//now build the url  
				var source =  host + '/mobile/feedback?task=initial&performance=' + gCurrentPerformance  ;  //TODO code to see what server the system is running on and build this URL 
				
				window.console.log(source);
				
				
				$.ajax({
						type:   'GET',
						url: source, 
						dataType: mydataType,
						success: function (data) {
							
							//check to make sure we do have some data
							if(data.event == '') {
								jQT.goTo('#Error');

							};
								
							populate(data);
							window.console.log(data);
						},
					
					error:function (xhr, ajaxOptions, thrownError){
                    	//alert(xhr.status);
                    	//alert(thrownError);
						jQT.goTo('#Error');

                	},
				
				
					async: true 
					}); 			

		}; 
		
		/*
		* This is the main call that loads the json in to the correct D
		*
		**/
		function populate(data){
			//alert("ye got here"); 
			//window.console.log(data);
			//$("#Add").item(data).chain();//load this data in the feedback 
			
			//This is a bit of hack - would be nice to just have this once and te form is not display 
			$(".feedback").items(data.feedback.sort(
			function(a, b){
		 		var dateA=new Date(a.date), dateB=new Date(b.date)
		 		return dateB- dateA
			}
			)).chain();//load this data in the feedback
			 
			$(".feedbackForm").items(data.feedback.sort(
			function(a, b){
		 		var dateA=new Date(a.date), dateB=new Date(b.date)
		 		return dateB- dateA
			}
			
			)).chain();//load this data in the feedback 
			$("#FeedbackDisplayWithForm").item(data).chain();//load this data in the feedback 	
			$("#FeedbackDisplay").item(data).chain();//load this data in the feedback 	
			
		
		};
		
	
		
		
		function loadFeedbackForm() {
		
		  var element = (event.target.nodeName == "SPAN") ? event.target.parentNode : event.target;
		  var CurrentPerformance =   $(element).children("span.performance").text();
		  gCurrentPerformance = CurrentPerformance;  
		  getPerformanceData();

				
		}; 
		
		
		
		function loadFeedback() {
		
		  var element = (event.target.nodeName == "SPAN") ? event.target.parentNode : event.target;
		  var CurrentPerformance =   $(element).children("span.performance").text();
		  gCurrentPerformance =  CurrentPerformance;  

		  getPerformanceData();

		}; 
		
	
		
        </script>
        <style type="text/css" media="screen">
            body.fullscreen #home .info {
                display: none;
            }
            #about {
                padding: 100px 10px 40px;
                text-shadow: rgba(255, 255, 255, 0.3) 0px -1px 0;
                font-size: 13px;
                text-align: center;
                background: #161618;
            }
            #about p {
                margin-bottom: 8px;
            }
            #about a {
                color: #fff;
                font-weight: bold;
                text-decoration: none;
            }
        </style>
    </head>
    <body >
       
 
         <div id="home" class="current">
            <div class="toolbar">
                <h1>AusStage</h1>
                <a class="button slideup" id="infoButton" href="#about">About</a>
            </div>
            
            <div class="info">
                <p>Intro</p>
            </div>
      	
            <ul class="rounded">
            
            <li class="arrow"><a href="#Near" onClick="findLocation()">Performances near you</a> <small class="counter">1</small></li> 
			<li class="arrow"><a href="#Search">Search</a> <small class="counter">2</small></li>
			<li class="arrow"><a href="#About">About</a><small class="counter">4</small></li>

            </ul>
            
             <script type="text/javascript" charset="utf-8">_gaq.push(['_trackPageview', 'Home']);</script>
        </div>


 <div id="Near">
            <div class="toolbar">
                <h1>Performances near you</h1>
                <a class="back" href="#">Home</a>
                <a class="button slideup" id="infoButton" href="#about">About</a>
            </div> 
         
  		<div class="LocInfo info">
                <p>Looking up location&hellip;</p>
            </div>
                     
        <ul class="rounded">
           <li class="arrow"><a href="#FeedbackDisplayWithForm"  onClick="loadFeedback(event)">Be Your Self <span class="performance">4</span></a> <small class="counter">1</small></li>		   
	   
        </ul>              
      
</div>


      
          <div id="Search">
            <div class="toolbar">
                <h1>Search</h1>
                <a class="back" href="#">Home</a>
                                <a class="button slideup" id="infoButton" href="#about">About</a>

            </div>  
             <script type="text/javascript" charset="utf-8">_gaq.push(['_trackPageview', 'Search']);</script>
        
         </div> 
        
          <div id="About-Panel">
            <div class="toolbar">
                <h1>About</h1>
                <a class="back" href="#">Home</a>
               <a class="button slideup" id="infoButton" href="#about">About</a>

            </div>  

         </div>        
         
          <div id="about" class="selectable">
               	
                <!--TODO add some about information to here-->
                About this service. 
                
                <p><br /><br /><a href="#" class="grayButton goback">Close</a></p>
                
             <script type="text/javascript" charset="utf-8">_gaq.push(['_trackPageview', 'About-Panel']);</script>

        </div>
   
     
                           
	 <div id="FeedbackDisplay">
            <div class="toolbar">
                <h1 class="event"></h1>
                <a class="back" href="#">Back</a>
               <a class="button slideup" id="infoButton" href="#about">About</a>

            </div>             
            
             <div class="info">
            
            <div class="organisation">organisation</div>
            <div class="venue">venue</div>
            <div class="date">date</div>
            </div>
            
           <span class="performance"></span>
           <h3 class="question"></h3>

            <ul class="feedback">
                    <li><span class="content"></span></li>
            </ul>
         	
         
         </div>  
         
            
            
         <div id="FeedbackDisplayWithForm">
            <div class="toolbar">
                <h1 class="event"></h1>
                <a class="back" href="#">Home</a>
               <a class="button slideup" id="infoButton" href="#about">About</a>

            </div>             
            
             <div class="info">
            
            <div class="organisation">organisation</div>
            <div class="venue">venue</div>
            <div class="date">date</div>
            </div>
            
           <span class="performance"></span>

             
         <form id="submit-feedback" action="" method="GET" class="form">
        		<h3 class="question">Question</h3>
				<ul class="edit rounded">
            		<li><textarea placeholder="" name="message"></textarea></li>
               </ul>
 			<a style="margin:0 10px;color:rgba(0,0,0,.9)" href="#" onClick="submitForm()" class="whiteButton">Submit</a>
         </form>
        
      
           <h3 class="question"></h3>

            <ul class="feedbackForm">
                    <li><span class="content"></span></li>
            </ul>
                  
         </div>  
         
         
           <div id="Error">
            <div class="toolbar">
                <h1>Error</h1>
               <a class="button slideup" id="infoButton" href="#about">About</a>

            </div>             
            
             <div class="info">
            
            	Something has gone wrong, that performance has cann't be found. Try going back the home page. 
                 
 			<a style="margin:0 10px;color:rgba(0,0,0,.9)" href="#home"  class="whiteButton">Home</a>
                
                
            </div>
                  <script type="text/javascript" charset="utf-8">_gaq.push(['_trackPageview', 'Error']);</script>

                  
         </div>  
         
         
            
      
    </body>
</html>